# .github/workflows/build.yml íŒŒì¼ ìƒì„±
# ì´ íŒŒì¼ì´ ìë™ ë¹Œë“œì˜ ì„¤ëª…ì„œì…ë‹ˆë‹¤

name: Build and Push Docker Image  # Actions íƒ­ì— í‘œì‹œë  ì´ë¦„

# íŠ¸ë¦¬ê±° ì¡°ê±´ (ì–¸ì œ ì‹¤í–‰í• ì§€)
# ì™œ main ë¸Œëœì¹˜ë§Œ? ê°œë°œ ì¤‘ì¸ ë¸Œëœì¹˜ëŠ” ë¹Œë“œí•˜ì§€ ì•Šê¸° ìœ„í•´
on:
  push:
    branches: [ main ]  # mainì— í‘¸ì‹œ ë˜ëŠ” PR ë¨¸ì§€ ì‹œ ì‹¤í–‰

# í™˜ê²½ë³€ìˆ˜ ì •ì˜
# ì™œ í™˜ê²½ë³€ìˆ˜ë¡œ? ì—¬ëŸ¬ ê³³ì—ì„œ ì¬ì‚¬ìš©í•˜ê¸° ìœ„í•´
env:
  REGISTRY: docker.io  # Docker Hub ì£¼ì†Œ
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/simple-gitops

jobs:
  build:
    runs-on: ubuntu-latest  # GitHubì´ ì œê³µí•˜ëŠ” Ubuntu ì„œë²„ì—ì„œ ì‹¤í–‰
    # ì™œ Ubuntu? ì•ˆì •ì ì´ê³  Docker ì§€ì› ìš°ìˆ˜
    
    steps:
    # Step 1: ì½”ë“œ ì²´í¬ì•„ì›ƒ
    # ì™œ í•„ìš”? GitHub Actions ì„œë²„ëŠ” ë¹ˆ ì„œë²„ì´ë¯€ë¡œ ì½”ë“œë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Step 2: ìë™ ë²„ì „ ìƒì„±
    # ì™œ ë‚ ì§œ-ì‹œê°„-í•´ì‹œ í˜•ì‹?
    # - ë‚ ì§œì‹œê°„: ì–¸ì œ ë¹Œë“œëëŠ”ì§€ ë°”ë¡œ ì•Œ ìˆ˜ ìˆìŒ
    # - ì»¤ë°‹í•´ì‹œ: ì–´ë–¤ ì½”ë“œì¸ì§€ ì •í™•íˆ ì¶”ì  ê°€ëŠ¥
    # - ì¡°í•©í•˜ë©´ ì ˆëŒ€ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ê³ ìœ í•œ íƒœê·¸ ìƒì„±
    - name: Generate version
      id: version
      run: |
        # íƒœê·¸ ìƒì„± (ì˜ˆ: 20241205-143022-abc1234)
        TAG=$(date +%Y%m%d-%H%M%S)-$(git rev-parse --short HEAD)
        
        # GitHub Actions ë³€ìˆ˜ë¡œ ì €ì¥
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        
        echo "ğŸ“¦ ìƒì„±ëœ ë²„ì „: ${TAG}"
    
    # Step 3: Docker Hub ë¡œê·¸ì¸
    # ì™œ í•„ìš”? ì´ë¯¸ì§€ë¥¼ í‘¸ì‹œí•˜ë ¤ë©´ ì¸ì¦ í•„ìš”
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        # secretsëŠ” GitHubì— ì•ˆì „í•˜ê²Œ ì €ì¥ëœ ë¹„ë°€ê°’
        # ì™œ secrets ì‚¬ìš©? ë¹„ë°€ë²ˆí˜¸ë¥¼ ì½”ë“œì— ì§ì ‘ ì“°ë©´ ìœ„í—˜
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    # Step 4: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    - name: Build and push
      run: |
        # ì´ë¯¸ì§€ ì´ë¦„ êµ¬ì„±
        IMAGE="${{ secrets.DOCKER_USERNAME }}/simple-gitops"
        
        # ë¹Œë“œ (ë‘ ê°œì˜ íƒœê·¸ ìƒì„±)
        # ì™œ ë‘ ê°œ? 
        # - íŠ¹ì • ë²„ì „ íƒœê·¸: ì •í™•í•œ ë²„ì „ ì¶”ì ìš©
        # - latest íƒœê·¸: ìµœì‹  ë²„ì „ ì°¸ì¡°ìš©
        docker build \
          --build-arg APP_VERSION=${{ steps.version.outputs.tag }} \
          -t ${IMAGE}:${{ steps.version.outputs.tag }} \
          -t ${IMAGE}:latest \
          .
        
        # Docker Hubì— í‘¸ì‹œ
        docker push ${IMAGE}:${{ steps.version.outputs.tag }}
        docker push ${IMAGE}:latest
        
        echo "âœ… ë¹Œë“œ ì™„ë£Œ!"
        echo "ğŸ”— https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/simple-gitops"